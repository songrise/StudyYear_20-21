-- FINAL_YEAR_PROJ
SET LINESIZE 150;
DROP TABLE STUDENT;
DROP TABLE WORKS_ON;
DROP TABLE PREFER;
DROP TABLE PROJECT;
DROP TABLE INSTRUCTOR;
commit;


CREATE TABLE STUDENT (
    STU_ID VARCHAR(5),
    STU_NAME VARCHAR(30) NOT NULL,
    EMAIL VARCHAR(40),
    PREFERENCE_FULFILLED NUMERIC(1,0) DEFAULT (0),
    CHECK (PREFERENCE_FULFILLED IN (0,1)),
    PRIMARY KEY (STU_ID)
);

CREATE TABLE INSTRUCTOR(
    INST_ID VARCHAR(5),
    INST_NAME VARCHAR(30) NOT NULL,
    EMAIL VARCHAR(40),
    PRIMARY KEY (INST_ID)
);

CREATE TABLE PROJECT(
    PROJ_ID NUMERIC(5,0),
    PROJ_TITLE VARCHAR(50) NOT NULL,
    INST_ID VARCHAR(5),
    PROJ_STATUS VARCHAR(10) DEFAULT 'AVAILABLE',
    PRIMARY KEY (PROJ_ID),
    FOREIGN KEY (INST_ID) REFERENCES INSTRUCTOR(INST_ID),
    CHECK (PROJ_STATUS IN ('AVAILABLE', 'IN PROCESS', 'FINISHED', 'CANCELED'))
);



CREATE TABLE WORKS_ON(
    STU_ID VARCHAR(5),
    PROJ_ID NUMERIC(5, 0),
    FOREIGN KEY (STU_ID) REFERENCES STUDENT(STU_ID),
    FOREIGN KEY (PROJ_ID) REFERENCES PROJECT(PROJ_ID),
    UNIQUE (PROJ_ID)
);

CREATE TABLE PREFER(
    STU_ID VARCHAR(5),
    PROJ_1 NUMERIC(5,0),
    PROJ_2 NUMERIC(5,0),
    PROJ_3 NUMERIC(5,0),
    PROJ_4 NUMERIC(5,0),
    PROJ_5 NUMERIC(5,0),
    FOREIGN KEY (STU_ID) REFERENCES STUDENT(STU_ID),
    FOREIGN KEY (PROJ_1) REFERENCES PROJECT(PROJ_ID),
    FOREIGN KEY (PROJ_2) REFERENCES PROJECT(PROJ_ID),
    FOREIGN KEY (PROJ_3) REFERENCES PROJECT(PROJ_ID),
    FOREIGN KEY (PROJ_4) REFERENCES PROJECT(PROJ_ID),
    FOREIGN KEY (PROJ_5) REFERENCES PROJECT(PROJ_ID)
);

--! This trigger tests if a student indicated 5 valid preference.
CREATE OR REPLACE TRIGGER PREFERENCE_FULFILLMENT_CHECK
AFTER INSERT OR UPDATE OF PROJ_1,PROJ_2,PROJ_3,PROJ_4,PROJ_5
ON PREFER
FOR EACH ROW
DECLARE 
    I NUMBER;
BEGIN
    IF :NEW.PROJ_1 IS NOT NULL AND :NEW.PROJ_2 IS NOT NULL AND :NEW.PROJ_3 IS NOT NULL AND :NEW.PROJ_4 IS NOT NULL AND :NEW.PROJ_5 IS NOT NULL THEN
        UPDATE STUDENT
        SET PREFERENCE_FULFILLED = 1
        WHERE STU_ID = :NEW.STU_ID;
    ELSE
        UPDATE STUDENT
        SET PREFERENCE_FULFILLED = 0
        WHERE STU_ID = :NEW.STU_ID;
    END IF;
END;
/



--! this trigger update project status after a student start to do it.
CREATE OR REPLACE TRIGGER PROJECT_DOING
AFTER INSERT ON WORKS_ON
FOR EACH ROW
BEGIN
    UPDATE PROJECT
    SET PROJ_STATUS = 'IN PROCESS'
    WHERE PROJ_ID = :NEW.PROJ_ID;
END;
/

-- this trigger checks validity of preference
CREATE OR REPLACE TRIGGER PREFERENCE_VALID_CHECK
BEFORE INSERT ON PREFER
FOR EACH ROW
DECLARE 
    STATUS VARCHAR(10);
BEGIN 
    SELECT PROJ_STATUS INTO STATUS 
        FROM PROJECT WHERE PROJ_ID = :NEW.PROJ_1;
    IF STATUS <> 'AVAILABLE' THEN
        RAISE_APPLICATION_ERROR(-20001,'Project1 inavailable!');
    END IF;
    SELECT PROJ_STATUS INTO STATUS 
        FROM PROJECT WHERE PROJ_ID = :NEW.PROJ_2;
    IF STATUS <> 'AVAILABLE' THEN
        RAISE_APPLICATION_ERROR(-20001,'Project2 inavailable!');
    END IF;    
    SELECT PROJ_STATUS INTO STATUS 
        FROM PROJECT WHERE PROJ_ID = :NEW.PROJ_3;
    IF STATUS <> 'AVAILABLE' THEN
        RAISE_APPLICATION_ERROR(-20001,'Project3 inavailable!');
    END IF;    
    SELECT PROJ_STATUS INTO STATUS 
        FROM PROJECT WHERE PROJ_ID = :NEW.PROJ_4;
    IF STATUS <> 'AVAILABLE' THEN
        RAISE_APPLICATION_ERROR(-20001,'Project4 inavailable!');
    END IF;
    SELECT PROJ_STATUS INTO STATUS 
        FROM PROJECT WHERE PROJ_ID = :NEW.PROJ_5;
    IF STATUS <> 'AVAILABLE' THEN
        RAISE_APPLICATION_ERROR(-20001,'Project5 inavailable!');
    END IF;


END;
/

COMMIT;

INSERT INTO STUDENT VALUES('S0001','Lawrence Vickers','Lawrence_Vickers@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0002','Olaf Williams','Olaf_Williams@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0003','Sierra Ashton','Sierra_Ashton@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0004','Jordan Lyon','Jordan_Lyon@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0005','Mared Clifford','Mared_Clifford@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0006','Kaitlyn Pope','Kaitlyn_Pope@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0007','Elli Villegas','Elli_Villegas@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0008','Fatima Guy','Fatima_Guy@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0009','Leonardo Wheatley','Leonardo_Wheatley@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0010','Elle Butt','Elle_Butt@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0011','Amiya Lord','Amiya_Lord@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0012','Connah Reeve','Connah_Reeve@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0013','Evalyn Humphreys','Evalyn_Humphreys@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0014','Chaya Murray','Chaya_Murray@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0015','Keelan Rich','Keelan_Rich@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0016','Naima Kirk','Naima_Kirk@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0017','Garrett Pate','Garrett_Pate@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0018','Emelie Mack','Emelie_Mack@ABC.edu',DEFAULT);
INSERT INTO STUDENT VALUES('S0019','Trystan Roche','Trystan_Roche@ABC.edu',DEFAULT);



INSERT INTO INSTRUCTOR VALUES('I0001','Jakob Senior','Jakob_Senior@ABC.edu');
INSERT INTO INSTRUCTOR VALUES('I0002','Darsh Miles','Darsh_Miles@ABC.edu');
INSERT INTO INSTRUCTOR VALUES('I0003','Kodi Waters','Kodi_Waters@ABC.edu');
INSERT INTO INSTRUCTOR VALUES('I0004','Victoria Cooper','Victoria_Cooper@ABC.edu');
INSERT INTO INSTRUCTOR VALUES('I0005','Gurdeep Churchill','Gurdeep_Churchill@ABC.edu');

INSERT INTO PROJECT VALUES(00001,'The stochastic approach for memories','I0001',DEFAULT);
INSERT INTO PROJECT VALUES(00002,'The chronic review of cognition','I0001',DEFAULT);
INSERT INTO PROJECT VALUES(00003,'The distributed data and cognition','I0001',DEFAULT);
INSERT INTO PROJECT VALUES(00004,'A implantable model of relativity','I0001',DEFAULT);
INSERT INTO PROJECT VALUES(00005,'A qualitative data for oxidation','I0002',DEFAULT);
INSERT INTO PROJECT VALUES(00006,'Systematic sensors engineering','I0002',DEFAULT);
INSERT INTO PROJECT VALUES(00007,'The evolutionary tariff and infrared','I0002',DEFAULT);
INSERT INTO PROJECT VALUES(00008,'Evolutionary covid-19 and cerebral','I0002',DEFAULT);
INSERT INTO PROJECT VALUES(00009,'Linear electrode of hydrocarbon','I0003',DEFAULT);
INSERT INTO PROJECT VALUES(00010,'Chronic method and immunity','I0003',DEFAULT);
INSERT INTO PROJECT VALUES(00011,'Distributed transformer hydrocarbon','I0003',DEFAULT);
INSERT INTO PROJECT VALUES(00012,'The centralized explanation for memories','I0003',DEFAULT);
INSERT INTO PROJECT VALUES(00013,'The implantable circuit with transformer','I0004',DEFAULT);
INSERT INTO PROJECT VALUES(00014,'Evolutionary explanation for hydrocarbon','I0004',DEFAULT);
INSERT INTO PROJECT VALUES(00015,'A adaptive cognition for enzyme','I0004',DEFAULT);
INSERT INTO PROJECT VALUES(00016,'A overturning glacier for conductivity','I0004',DEFAULT);
INSERT INTO PROJECT VALUES(00017,'Deep infrared for database','I0005',DEFAULT);
INSERT INTO PROJECT VALUES(00018,'The underestimated atom of legislation','I0005',DEFAULT);
INSERT INTO PROJECT VALUES(00019,'A qualitative model with population','I0005',DEFAULT);
INSERT INTO PROJECT VALUES(00020,'Do not select this project','I0005',DEFAULT);

INSERT INTO PREFER VALUES ('S0001',00001,00005,00009,00013,00017);
INSERT INTO PREFER VALUES ('S0002',00002,00006,00010,00014,00018);
INSERT INTO PREFER VALUES ('S0003',00003,00007,00011,00015,00019);
INSERT INTO PREFER VALUES ('S0004',00004,00008,00012,00016,00020);
INSERT INTO PREFER VALUES ('S0005',00001,00005,00009,00013,00017);
INSERT INTO PREFER VALUES ('S0006',00002,00006,00010,00014,00018);
INSERT INTO PREFER VALUES ('S0007',00003,00007,00011,00015,00019);
INSERT INTO PREFER VALUES ('S0008',00004,00008,00012,00016,00020);
INSERT INTO PREFER VALUES ('S0009',00001,00005,00009,00013,00017);
INSERT INTO PREFER VALUES ('S0010',00002,00006,00010,00014,00018);
INSERT INTO PREFER VALUES ('S0011',00003,00007,00011,00015,00019);
INSERT INTO PREFER VALUES ('S0012',00004,00008,00012,00016,00020);
INSERT INTO PREFER VALUES ('S0013',00001,00005,00009,00013,00017);
INSERT INTO PREFER VALUES ('S0014',00002,00006,00010,00014,00018);
INSERT INTO PREFER VALUES ('S0015',00003,00007,00011,00015,00019);
INSERT INTO PREFER VALUES ('S0016',00004,00008,00012,00016,00020);
INSERT INTO PREFER VALUES ('S0017',00001,00005,00009,00013,00017);
INSERT INTO PREFER VALUES ('S0018',00002,00006,00010,00014,00018);
INSERT INTO PREFER VALUES ('S0019',00003,00007,00011,00015,00019);

INSERT INTO WORKS_ON VALUES ('S0001',00001);
INSERT INTO WORKS_ON VALUES ('S0002',00002);
INSERT INTO WORKS_ON VALUES ('S0003',00003);
INSERT INTO WORKS_ON VALUES ('S0004',00004);
INSERT INTO WORKS_ON VALUES ('S0005',00005);
INSERT INTO WORKS_ON VALUES ('S0006',00006);
INSERT INTO WORKS_ON VALUES ('S0007',00007);
INSERT INTO WORKS_ON VALUES ('S0008',00008);
INSERT INTO WORKS_ON VALUES ('S0009',00009);
INSERT INTO WORKS_ON VALUES ('S0010',00010);
INSERT INTO WORKS_ON VALUES ('S0011',00011);
INSERT INTO WORKS_ON VALUES ('S0012',00012);
INSERT INTO WORKS_ON VALUES ('S0013',00013);
INSERT INTO WORKS_ON VALUES ('S0014',00014);
INSERT INTO WORKS_ON VALUES ('S0015',00015);
INSERT INTO WORKS_ON VALUES ('S0016',00016);
INSERT INTO WORKS_ON VALUES ('S0017',00017);
INSERT INTO WORKS_ON VALUES ('S0018',00018);
INSERT INTO WORKS_ON VALUES ('S0019',00019);



COMMIT;
-- This is contact information
SELECT PROJ_ID, STUDENT.EMAIL AS STUDENT_EMAIL, INSTRUCTOR.EMAIL AS INSTRUCTOR_EMAIL
FROM STUDENT NATURAL JOIN WORKS_ON
             NATURAL JOIN PROJECT 
             LEFT JOIN INSTRUCTOR ON PROJECT.INST_ID = INSTRUCTOR.INST_ID;

-- this two lines shows how preference_fulfilled work
UPDATE PREFER SET PROJ_1 = NULL WHERE STU_ID = 'S0001';
SELECT * FROM STUDENT WHERE STU_ID = 'S0001'


INSERT INTO WORKS_ON VALUES ('S0002',00001);
INSERT INTO PREFER VALUES ('S0001',00001,00005,00009,00013,00017);
